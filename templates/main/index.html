<!doctype html>
{% load static %}
{% load custom_tags %}
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->

    <link href="{% static 'b5/css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/ol-layerswitcher@4.1.1/dist/ol-layerswitcher.css" />
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <link rel="stylesheet" href="https://openlayers.org/en/v3.20.1/css/ol.css" type="text/css">
    <link href="{% static 'css/style.default.css'%}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'jquery-ui.css' %}">

<style>
    /* CSS for Responsive Navigation Bar */
.navbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background-color: #333;
}

.navbar ul {
  list-style: none;
  display: flex;
}

.navbar li {
  margin-right: 1rem;
}

@media (max-width: 768px) {
  .navbar ul {
    display: none;
    flex-direction: column;
    position: absolute;
    top: 4rem;
    left: 0;
    width: 100%;
    background-color: #333;
  }

  .navbar ul.show {
    display: flex;
  }

  .navbar li {
    margin: 0;
    padding: 1rem;
    border-bottom: 1px solid #555;
    width: 100%;
    text-align: center;
  }

  .menu-icon {
    display: block;
  }
}
    .nn{
        width: 50% !important;
    }
    .hover-zoom {
  /* Set initial image dimensions */
  width: 200px;
  height: 150px;
  object-fit: cover; /* Keeps aspect ratio on resize */
  transition: transform 0.3s ease-in-out; /* Smooth animation */
  cursor: zoom-in; /* Change cursor on hover */
}

.hover-zoom:hover {
  transform: scale(1.2); /* Enlarge image on hover */
}

    .image-container {
  overflow: hidden; /* This is important for the animation to work */
}

.image-container img {
  animation: slide-in 2s ease-in-out forwards;
}

@keyframes slide-in {
  0% {
    transform: translateX(-100%); /* Start image off-screen to the left */
  }
  100% {
    transform: translateX(0); /* Slide image to the right */
  }
}
    .property-overlay {
        position: absolute;
  background-color: white;
  border: 1px solid #ccc;
  padding: 18px;
  max-width: 568px;
  overflow-x: scroll;
}

.property-overlay span.close-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    cursor: pointer;
}

    #pills-tabContent{
        height: 100vh;
    }
 .tree-view {
        list-style: none;
        overflow-y: scroll;
  height: 100vh;

    }
.form-control{
    width: 30%;
}
 

    .tree-view li.collapsible > ul {
        display: none;
    }

    .tree-view li.collapsible::before {
        content: '►';
        position: absolute;
        left: -20px;
    }

    .tree-view li.collapsible.collapsed::before {
        content: '▶';
    }

    .tree-view li:last-child {
        margin-left: 0;
    }

    .tree-view li:last-child::before {
        content: none;
    }

</style>


    <title>GO Tour</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'main:index' %}">GO Tour</a>
            <a class="navbar-brand" href="{% url 'main:app' %}">App</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <input id="autocomplete-input" class="form-control mr-sm-2" type="text"
            placeholder="Search Destinations or Services" aria-label="Search" autocomplete="off">
    </div>
    </nav>

    <!-- Rest of your content -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-3">


                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home"
                            aria-selected="true">Catalog</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pills-routing-tab" data-bs-toggle="pill"
                            data-bs-target="#pills-routing" type="button" role="tab" aria-controls="pills-routing"
                            aria-selected="false">Route</button>
                    </li>
                </ul>
                <div class="tab-content" id="pills-tabContent">
                    <div class="row" style="justify-content: center;">
                        <button class="btn btn-primary col-3" onclick="location.reload()">clear</button>
                        <button class="btn btn-primary col-3" onclick="geolocateMe()">geolocate me</button>
                    </div>
                    <br>
                    <div class="tab-pane fade show active" id="pills-home" role="tabpanel"
                        aria-labelledby="pills-home-tab">
                        <ul id="treeview" class="tree-view">
                            <li>
                                <span class="collapse-icon bi bi-chevron-right" data-toggle="collapse" data-target="#step1"></span>
                                <input type="checkbox" id="step1" />
                                <label for="step1">Services ({{combined_data.services.count}})</label>
                        
                                <ul id="step1" class="collapse">
                                  

                                    {% for service_info in combined_data.services|get_distinct_service_ty_info %}
                                    <li>
                                        <span class="collapse-icon bi bi-chevron-right" data-toggle="collapse" data-target="#{{ service_info.service_type }}"></span>
                                        <input type="checkbox" id="{{ service_info.service_type }}" data-x="{{ obj.x }}" data-y="{{ obj.y }}"> <label for="{{ service_info.service_type }}">{{ service_info.service_type }}</label>
                                        {% if service_info.service_type == "Air Port" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Bank" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Beverage" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Bus Terminal" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Café" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Camp Site" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Catholic Church" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Clinic" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "College" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Garage" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Gas Station" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Health Center" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Health Post" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Hospital" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Hotel" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Lodge" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Mosque" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Municipal" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Museum" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Office" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Open Market" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Orthodox Church" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Pension" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Pharmacy" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Police Station" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Protestant Church" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "Repair" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Restaurant" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "School" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Stadium" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% elif service_info.service_type == "Supper Market" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})
{% elif service_info.service_type == "University" %}
<i class="bi bi-person-hearts"></i> ({{ service_info.count }})

{% endif %}
                                        <ul id="{{ service_info.service_type }}" class="collapse">
                                            {% for obj in service_info.objects %}
                                                <li>
                                                    <input type="checkbox" id="{{ obj.id }}" 
                                                    data-whatType="services" 
                                                    data-geom="{{ obj.geom }}" 
     data-objectid="{{ obj.objectid }}" 
     data-x="{{ obj.x }}" 
     data-y="{{ obj.y }}"
     data-z="{{ obj.z }}"
     data-code="{{ obj.code }}"
     data-full_name="{{ obj.full_name }}"
     data-short_name="{{ obj.short_name }}"
     data-zone="{{ obj.zone }}"
     data-wereda="{{ obj.wereda }}"
     data-kebele="{{ obj.kebele }}"
     data-phone_line="{{ obj.phone_line }}"
     data-email="{{ obj.email }}"
     data-website="{{ obj.website }}"
     data-service_ty="{{ obj.service_ty }}"
     data-owner_name="{{ obj.owner_name }}"
     data-moto="{{ obj.moto }}"
     > <label for="{{ obj.id }}" style="font-size: 13px;">{{ obj.full_name }}</label>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                {% endfor %}
                                </ul>
                            </li>
                          

                            <li>
                                <span class="collapse-icon bi bi-chevron-right" data-toggle="collapse" data-target="#step1"></span>
                                <input type="checkbox" id="step1" />
                                <label for="step1">Attraction Site({{combined_data.destinations.count}})</label>
                        
                                <ul id="step1" class="collapse">
                                   
                                    {% for destibnation_info in combined_data.destinations|get_distinct_destinations_ty_info %}
                                    <li>
                                        <span class="collapse-icon bi bi-chevron-right" data-toggle="collapse" data-target="#{{ destibnation_info.destinatio }}"></span>
                                        <input type="checkbox" 
                                        id="{{ destibnation_info.destinatio }}" 
                                       >{{ destibnation_info.destination_type }}</label>
                                        {% if destibnation_info.destination_type == "Cultural" %}
                                        <i class="bi bi-person-hearts"></i>  {% elif destibnation_info.destination_type == "Man Made" %}
                                        <i class="bi bi-person-hearts"></i>  {% elif destibnation_info.destination_type == "Natural" %}
                                        <i class="bi bi-person-hearts"></i>  {% endif %}
                                        ({{ destibnation_info.count }})                                    
                                        <ul id="{{ destibnation_info.destinatio }}" class="collapse">
                                            {% for obj in destibnation_info.objects %}
                                            {{obj.full}}
                                                <li>
                                                    <input type="checkbox" id="{{ obj.id }}" 
                                                    data-whatType="destinations" 
                                                    data-geom="{{ obj.geom }}" 
                                                    data-objectid="{{ obj.objectid }}" 
                                                    data-name="{{ obj.name }}" 
                                                    data-datetimes="{{ obj.datetimes }}" 
                                                    data-elevation="{{ obj.elevation }}" 
                                                    data-code="{{ obj.code }}" 
                                                    data-full_name="{{ obj.full_name }}" 
                                                    data-short_name="{{ obj.short_name }}" 
                                                    data-zone="{{ obj.zone }}" 
                                                    data-wereda="{{ obj.wereda }}" 
                                                    data-kebele="{{ obj.kebele }}" 
                                                    data-locality_n="{{ obj.locality_n }}" 
                                                    data-organizati="{{ obj.organizati }}" 
                                                    data-destinatio="{{ obj.destinatio }}" 
                                                    data-status="{{ obj.status }}" 
                                                    data-area_sqkm="{{ obj.area_sqkm }}" 
                                                    data-yearly_est="{{ obj.yearly_est }}" 
                                                    data-unesco_reg="{{ obj.unesco_reg }}" 
                                                    data-descriptio="{{ obj.descriptio }}" 
                                                    data-photo_no="{{ obj.photo_no }}" 
                                                    data-photo_loca="{{ obj.photo_loca }}" 
                                                    data-site_des_a="{{ obj.site_des_a }}" 
                                                    data-amharic="{{ obj.amharic }}" 
                                                    data-english="{{ obj.english }}" 
                                                    data-x="{{ obj.x }}" 
                                                    data-y="{{ obj.y }}" 
                                                    data-image1="{{ obj.image1 }}" 
                                                    data-image2="{{ obj.image2 }}">    
                                                    <label for="{{ obj.destinatio }}"
                                                    > <label for="{{ obj.id }}" style="font-size: 13px;">{{ obj.full_name }}</label>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                {% endfor %}
                                </ul>
                            </li>
                        </ul>
                        
                        
                        
                    </li>
                   
                        </ul>
                    </div>
                    <div class="tab-pane fade" id="pills-routing" role="tabpanel" aria-labelledby="pills-routing-tab">
                        <div class="form-group">
                          <input type="text" class="form-control nn" id="sourceLocation" placeholder="Enter source location" autocomplete="off">
                        </div>
                        <br>
                        <div class="form-group">
                          <input type="text" class="form-control nn" id="targetLocation" placeholder="Enter target location" autocomplete="off">
                        </div>
                        <br>
                        <button class="btn btn-primary" onclick="makeRoute()">Route</button>
                       
                        <div class="container mt-3">
                            <h1>Distance Calculator</h1>
                            <hr>
                            <div class="row">
                              <div class="col-sm-6">
                                <h3>Total Distance:</h3>
                                <p id="total-distance"></p>
                              </div>
                              <div class="col-sm-6">
                                <h3>Travel Times:</h3>
                                <ul id="travel-times">
                                </ul>
                              </div>
                            </div>
                          </div>
                       </div>

                </div>


            </div>
            <div class="col-9">
                <div id="map-canvas"></div>
                <div id="property-overlay" class="property-overlay" style="display: none;">
                    <b>Service Properties</b><br>
                    Name:<span id="full_name-label"></span><br>
                    Zone:<span id="zone-label"></span><br>
                    Wereda:<span id="wereda-label"></span><br>
                    Kebele:<span id="kebele-label"></span><br>
                    Phone:<span id="phone_line-label"></span><br>
                    Email:<span id="email-label"></span><br>
                    Service Type:<span id="service_ty-label"></span><br>
                    Owner Name<span id="owner_name-label"></span><br>
                    Moto:<span id="moto-label"></span><br>
                    </div>
                    <div id="property-overlay2" class="property-overlay" style="display: none;">
                        <b>Destination Properties</b><br>
                        Name: <span id="zone-label2"></span><br>
                        Zone:<span id="wereda-label2"></span><br>
                        Wereda:<span id="kebele-label2"></span><br>
                        Kebele:<span id="destinatio-label2"></span><br>
                        Area in KM square:<span id="area_sqkm-label2"></span><br>
                        Establishment Year:<span id="yearly_est-label2"></span><br>
                        UNESCO Registration<span id="unesco_reg-label2"></span><br>
                        <span id="photo_no-label2"></span><br>
                        <span id="photo_loca-label2"></span><br>
                        Amharic Description:<span id="amharic-label2"></span><br>
                        English Description<span id="english-label2"></span><br>
                        <div class="image-container">
                            <img id="image1-label2" src="" style="width: 200px; height: 150px;" class="hover-zoom" />
                            <img id="image2-label2" src="" style="width: 200px; height: 150px;" class="hover-zoom" />
                          </div>
                        </div>

            </div>

        </div>
    </div>
   
    <script src="{% static 'b5/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'js/jquery-1.10.2.min.js'%}"></script>

    <script src="{% static 'ol.js' %}"></script>
    <script src="{% static 'jquery-ui.js' %}"></script>
    <script src="https://unpkg.com/ol-layerswitcher@4.1.1"></script>

    <script>
       function geolocateMe() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = ol.proj.fromLonLat([position.coords.longitude, position.coords.latitude]);
                    map.getView().setCenter(pos);
                    map.getView().setZoom(10); // Zoom in to a suitable level
                }, function(error) {
                    alert('Geolocation failed. ' + error.message);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }
         var source;
  var target;
      $(function() {
        
  var combinedData = JSON.parse("{{ combined_data_autocomplete|escapejs }}");

  var availableTags = [];
  // Combine service and destination full names into a single array
  combinedData.services.forEach(function(service) {
      availableTags.push({ label: service.full_name, value: service.full_name,
       whattype:"services",
      geom: service.geom, 
                    objectid: service.objectid, 
                    x: service.x, 
                    y: service.y, 
                    z: service.z, 
                    code: service.code, 
                    full_name: service.full_name,
                    short_name: service.short_name, 
                    zone: service.zone,
                     wereda: service.wereda, 
                     kebele: service.kebele, 
                     phone_line: service.phone_line,
                      email: service.email, 
                      website: service.website, 
                      service_ty: service.service_ty,
                       owner_name: service.owner_name, 
                       moto: service.moto
      
    });
  });
  combinedData.destinations.forEach(function(destination) {
      availableTags.push({ label: destination.full_name, value: destination.full_name,
        whattype:"destinations",
      geom: destination.geom,
    objectid: destination.objectid,
    name: destination.name,
    datetimes: destination.datetimes,
    elevation: destination.elevation,
    code: destination.code,
    full_name: destination.full_name,
    short_name: destination.short_name,
    zone: destination.zone,
    wereda: destination.wereda,
    kebele: destination.kebele,
    locality_n: destination.locality_n,
    organizati: destination.organizati,
    destinatio: destination.destinatio,
    status: destination.status,
    area_sqkm: destination.area_sqkm,
    yearly_est: destination.yearly_est,
    unesco_reg: destination.unesco_reg,
    descriptio: destination.descriptio,
    photo_no: destination.photo_no,
    photo_loca: destination.photo_loca,
    site_des_a: destination.site_des_a,
    amharic: destination.amharic,
    english: destination.english,
    x: destination.x,
    y: destination.y,
    image1: destination.image1,
    image2: destination.image2  });
  });
 
  var pointLayer; // Declare pointLayer outside the select event handler to maintain reference
  $("#autocomplete-input").autocomplete({
    source: availableTags,
    select: function(event, ui) {
        // Clear previous pointLayer if exists
        if (pointLayer) {
            map.removeLayer(pointLayer);
        }
console.log(ui.item)
        // Get the selected item data
        var selectedItem = ui.item;

// Check if x and y coordinates exist
if (selectedItem.hasOwnProperty('x') && selectedItem.hasOwnProperty('y')) {
    var pointFeature = new ol.Feature();

    if(selectedItem.whattype=="services"){
        
pointFeature.setGeometry(new ol.geom.Point([selectedItem.x, selectedItem.y]));
pointFeature.set('whattype', 'services');
pointFeature.set('geom', selectedItem.geom);
pointFeature.set('objectid', selectedItem.objectid);
pointFeature.set('x', selectedItem.x);
pointFeature.set('y', selectedItem.y);
pointFeature.set('z', selectedItem.z);
pointFeature.set('code', selectedItem.code);
pointFeature.set('full_name', selectedItem.full_name);
pointFeature.set('short_name', selectedItem.short_name);
pointFeature.set('zone', selectedItem.zone);
pointFeature.set('wereda', selectedItem.wereda);
pointFeature.set('kebele', selectedItem.kebele);
pointFeature.set('phone_line', selectedItem.phone_line);
pointFeature.set('email', selectedItem.email);
pointFeature.set('website', selectedItem.website);
pointFeature.set('service_ty', selectedItem.service_ty);
pointFeature.set('owner_name', selectedItem.owner_name);
pointFeature.set('moto', selectedItem.moto);

   
  
    }
    if(selectedItem.whattype=="destinations"){
        
pointFeature.setGeometry(new ol.geom.Point([selectedItem.x, selectedItem.y]));
pointFeature.set('whattype', 'destinations');
pointFeature.set('geom', selectedItem.geom);
pointFeature.set('objectid', selectedItem.objectid);
pointFeature.set('name', selectedItem.name);
pointFeature.set('datetimes', selectedItem.datetimes);
pointFeature.set('elevation', selectedItem.elevation);
pointFeature.set('code', selectedItem.code);
pointFeature.set('full_name', selectedItem.full_name);
pointFeature.set('short_name', selectedItem.short_name);
pointFeature.set('zone', selectedItem.zone);
pointFeature.set('wereda', selectedItem.wereda);
pointFeature.set('kebele', selectedItem.kebele);
pointFeature.set('locality_n', selectedItem.locality_n);
pointFeature.set('organizati', selectedItem.organizati);
pointFeature.set('destinatio', selectedItem.destinatio);
pointFeature.set('status', selectedItem.status);
pointFeature.set('area_sqkm', selectedItem.area_sqkm);
pointFeature.set('yearly_est', selectedItem.yearly_est);
pointFeature.set('unesco_reg', selectedItem.unesco_reg);
pointFeature.set('descriptio', selectedItem.descriptio);
pointFeature.set('photo_no', selectedItem.photo_no);
pointFeature.set('photo_loca', selectedItem.photo_loca);
pointFeature.set('site_des_a', selectedItem.site_des_a);
pointFeature.set('amharic', selectedItem.amharic);
pointFeature.set('english', selectedItem.english);
pointFeature.set('x', selectedItem.x);
pointFeature.set('y', selectedItem.y);
pointFeature.set('image1', selectedItem.image1);
pointFeature.set('image2', selectedItem.image2);

    }
  

    // Create a vector layer to hold the point feature
    pointLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [pointFeature],
            
        }),
        style:new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({color: "yellow"}),
                stroke: new ol.style.Stroke({color: "red", width: 2})
            })
        })
    });
    const layers = map.getLayers();


    // Add the point layer to the map
    map.addLayer(pointLayer);

    // Get the current zoom level
    var currentZoom_ = map.getView().getZoom();

    // Set the center of the map to the selected point
    var center = [selectedItem.x, selectedItem.y];
    map.getView().animate({
        center: center,
        zoom: currentZoom_ + 2, // You can adjust the zoom level here
        duration: 1000 // Duration of the animation in milliseconds
    });

        } else {
            console.warn("Selected item doesn't have x and y coordinates");
        }
    }
});
var pointLayerSource;
var shortestPathLayer;
$("#sourceLocation").autocomplete({
    source: availableTags,
    select: function(event, ui) {
        // Clear previous pointLayer if exists
        if (pointLayerSource) {
            map.removeLayer(pointLayerSource);
        }
        const layers = map.getLayers();


// Find the layer by name:
const shortestPathLayer = layers.getArray().find(layer => layer.get('name') === 'shortest_path');
console.log("bvk;lkbv",shortestPathLayer)
if (shortestPathLayer) {
  map.removeLayer(shortestPathLayer)
} else {
  console.error('Layer with name "shortest_path" not found on the map.');
}
 
console.log(ui.item)
        // Get the selected item data
        var selectedItem = ui.item;

// Check if x and y coordinates exist
if (selectedItem.hasOwnProperty('x') && selectedItem.hasOwnProperty('y')) {
    var pointFeature = new ol.Feature();

    if(selectedItem.whattype=="services"){
 var url = "http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=routing:nearest_vertex&outputformat=application/json&viewparams=x:"+selectedItem.x+";y:"+selectedItem.y+";"
 $.ajax({
                        jsonp: false,
                       
                        url: url,
                        async: false,
                        success: function(data) {
                            console.log(data)
                            source=data.features[0].properties.id
                            

pointFeature.setGeometry(new ol.geom.Point([data.features[0].geometry.coordinates[0], data.features[0].geometry.coordinates[1]]));
pointFeature.set('whattype', 'services');
pointFeature.set('geom', selectedItem.geom);
pointFeature.set('objectid', selectedItem.objectid);
pointFeature.set('x', selectedItem.x);
pointFeature.set('y', selectedItem.y);
pointFeature.set('z', selectedItem.z);
pointFeature.set('code', selectedItem.code);
pointFeature.set('full_name', selectedItem.full_name);
pointFeature.set('short_name', selectedItem.short_name);
pointFeature.set('zone', selectedItem.zone);
pointFeature.set('wereda', selectedItem.wereda);
pointFeature.set('kebele', selectedItem.kebele);
pointFeature.set('phone_line', selectedItem.phone_line);
pointFeature.set('email', selectedItem.email);
pointFeature.set('website', selectedItem.website);
pointFeature.set('service_ty', selectedItem.service_ty);
pointFeature.set('owner_name', selectedItem.owner_name);
pointFeature.set('moto', selectedItem.moto);
                        }
                    });


   
  
    }
    if(selectedItem.whattype=="destinations"){
        var url = "http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=routing:nearest_vertex&outputformat=application/json&viewparams=x:"+selectedItem.x+";y:"+selectedItem.y+";"

$.ajax({
                       jsonp: false,
                      
                       url: url,
                       async: false,
                       success: function(data) {
                        source=data.features[0].properties.id
        pointFeature.setGeometry(new ol.geom.Point([data.features[0].geometry.coordinates[0], data.features[0].geometry.coordinates[1]]));
pointFeature.set('whattype', 'destinations');
pointFeature.set('geom', selectedItem.geom);
pointFeature.set('objectid', selectedItem.objectid);
pointFeature.set('name', selectedItem.name);
pointFeature.set('datetimes', selectedItem.datetimes);
pointFeature.set('elevation', selectedItem.elevation);
pointFeature.set('code', selectedItem.code);
pointFeature.set('full_name', selectedItem.full_name);
pointFeature.set('short_name', selectedItem.short_name);
pointFeature.set('zone', selectedItem.zone);
pointFeature.set('wereda', selectedItem.wereda);
pointFeature.set('kebele', selectedItem.kebele);
pointFeature.set('locality_n', selectedItem.locality_n);
pointFeature.set('organizati', selectedItem.organizati);
pointFeature.set('destinatio', selectedItem.destinatio);
pointFeature.set('status', selectedItem.status);
pointFeature.set('area_sqkm', selectedItem.area_sqkm);
pointFeature.set('yearly_est', selectedItem.yearly_est);
pointFeature.set('unesco_reg', selectedItem.unesco_reg);
pointFeature.set('descriptio', selectedItem.descriptio);
pointFeature.set('photo_no', selectedItem.photo_no);
pointFeature.set('photo_loca', selectedItem.photo_loca);
pointFeature.set('site_des_a', selectedItem.site_des_a);
pointFeature.set('amharic', selectedItem.amharic);
pointFeature.set('english', selectedItem.english);
pointFeature.set('x', selectedItem.x);
pointFeature.set('y', selectedItem.y);
pointFeature.set('image1', selectedItem.image1);
pointFeature.set('image2', selectedItem.image2);



}
});
    }
  

    // Create a vector layer to hold the point feature
    pointLayerSource = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [pointFeature],
            
        }),
        style:new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({color: "red"}),
                stroke: new ol.style.Stroke({color: "blue", width: 2})
            })
        })
    });
    

    // Add the point layer to the map
    map.addLayer(pointLayerSource);

    // Get the current zoom level
    var currentZoom_ = map.getView().getZoom();

    // Set the center of the map to the selected point
    var center = [selectedItem.x, selectedItem.y];
    map.getView().animate({
        center: center,
        zoom: currentZoom_ + 2, // You can adjust the zoom level here
        duration: 1000 // Duration of the animation in milliseconds
    });

        } else {
            console.warn("Selected item doesn't have x and y coordinates");
        }
    }
});
var pointLayerTarget;
$("#targetLocation").autocomplete({
    source: availableTags,
    select: function(event, ui) {
        // Clear previous pointLayer if exists
        if (pointLayerTarget) {
            map.removeLayer(pointLayerTarget);
        }
        const layers = map.getLayers();


// Find the layer by name:
const shortestPathLayer = layers.getArray().find(layer => layer.get('name') === 'shortest_path');
console.log("bvk;lkbv",shortestPathLayer)
if (shortestPathLayer) {
  map.removeLayer(shortestPathLayer)
} else {
  console.error('Layer with name "shortest_path" not found on the map.');
}
 
console.log(ui.item)
        // Get the selected item data
        var selectedItem = ui.item;

// Check if x and y coordinates exist
if (selectedItem.hasOwnProperty('x') && selectedItem.hasOwnProperty('y')) {
    var pointFeature = new ol.Feature();

    if(selectedItem.whattype=="services"){
        var url = "http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=routing:nearest_vertex&outputformat=application/json&viewparams=x:"+selectedItem.x+";y:"+selectedItem.y+";"

$.ajax({
                       jsonp: false,
                      
                       url: url,
                       async: false,
                       success: function(data) {
        pointFeature.setGeometry(new ol.geom.Point([data.features[0].geometry.coordinates[0], data.features[0].geometry.coordinates[1]]));

        target=data.features[0].properties.id

pointFeature.setGeometry(new ol.geom.Point([selectedItem.x, selectedItem.y]));
pointFeature.set('whattype', 'services');
pointFeature.set('geom', selectedItem.geom);
pointFeature.set('objectid', selectedItem.objectid);
pointFeature.set('x', selectedItem.x);
pointFeature.set('y', selectedItem.y);
pointFeature.set('z', selectedItem.z);
pointFeature.set('code', selectedItem.code);
pointFeature.set('full_name', selectedItem.full_name);
pointFeature.set('short_name', selectedItem.short_name);
pointFeature.set('zone', selectedItem.zone);
pointFeature.set('wereda', selectedItem.wereda);
pointFeature.set('kebele', selectedItem.kebele);
pointFeature.set('phone_line', selectedItem.phone_line);
pointFeature.set('email', selectedItem.email);
pointFeature.set('website', selectedItem.website);
pointFeature.set('service_ty', selectedItem.service_ty);
pointFeature.set('owner_name', selectedItem.owner_name);
pointFeature.set('moto', selectedItem.moto);
                       }
                       })
                    
  
    }
    if(selectedItem.whattype=="destinations"){
        var url = "http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=routing:nearest_vertex&outputformat=application/json&viewparams=x:"+selectedItem.x+";y:"+selectedItem.y+";"

$.ajax({
                       jsonp: false,
                      
                       url: url,
                       async: false,
                       success: function(data) {
        pointFeature.setGeometry(new ol.geom.Point([data.features[0].geometry.coordinates[0], data.features[0].geometry.coordinates[1]]));

        target=data.features[0].properties.id


pointFeature.setGeometry(new ol.geom.Point([selectedItem.x, selectedItem.y]));
pointFeature.set('whattype', 'destinations');
pointFeature.set('geom', selectedItem.geom);
pointFeature.set('objectid', selectedItem.objectid);
pointFeature.set('name', selectedItem.name);
pointFeature.set('datetimes', selectedItem.datetimes);
pointFeature.set('elevation', selectedItem.elevation);
pointFeature.set('code', selectedItem.code);
pointFeature.set('full_name', selectedItem.full_name);
pointFeature.set('short_name', selectedItem.short_name);
pointFeature.set('zone', selectedItem.zone);
pointFeature.set('wereda', selectedItem.wereda);
pointFeature.set('kebele', selectedItem.kebele);
pointFeature.set('locality_n', selectedItem.locality_n);
pointFeature.set('organizati', selectedItem.organizati);
pointFeature.set('destinatio', selectedItem.destinatio);
pointFeature.set('status', selectedItem.status);
pointFeature.set('area_sqkm', selectedItem.area_sqkm);
pointFeature.set('yearly_est', selectedItem.yearly_est);
pointFeature.set('unesco_reg', selectedItem.unesco_reg);
pointFeature.set('descriptio', selectedItem.descriptio);
pointFeature.set('photo_no', selectedItem.photo_no);
pointFeature.set('photo_loca', selectedItem.photo_loca);
pointFeature.set('site_des_a', selectedItem.site_des_a);
pointFeature.set('amharic', selectedItem.amharic);
pointFeature.set('english', selectedItem.english);
pointFeature.set('x', selectedItem.x);
pointFeature.set('y', selectedItem.y);
pointFeature.set('image1', selectedItem.image1);
pointFeature.set('image2', selectedItem.image2);
                       }
                    })
    }
  

    // Create a vector layer to hold the point feature
    pointLayerTarget = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [pointFeature],
            
        }),
        style:new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({color: "blue"}),
                stroke: new ol.style.Stroke({color: "red", width: 2})
            })
        })
    });
   
    // Add the point layer to the map
    map.addLayer(pointLayerTarget);

    // Get the current zoom level
    var currentZoom_ = map.getView().getZoom();

    // Set the center of the map to the selected point
    var center = [selectedItem.x, selectedItem.y];
    map.getView().animate({
        center: center,
        zoom: currentZoom_ + 2, // You can adjust the zoom level here
        duration: 1000 // Duration of the animation in milliseconds
    });

        } else {
            console.warn("Selected item doesn't have x and y coordinates");
        }
    }
});

});

function makeRoute(){
    console.log(source)
    console.log(target)
    var url = "http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=routing:shortest_path&outputformat=application/json&viewparams=source:"+source+";target:"+target+""

$.ajax({
                       jsonp: false,
                      
                       url: url,
                       async: false,
                       success: function(data) {
                        console.log("pppp",data)
                        var format = new ol.format.GeoJSON();

// 2. Parse the features from the data:
var features = format.readFeatures(data, {
  // Set featureProjection if your data has a different projection
  // than the map projection:
  featureProjection: 'EPSG:4326'
});

// Initialize a variable to store the total distance
let totalDistanceKm = 0;
    for (const feature of data.features) {
      if (feature.properties && feature.properties.distance) {
        totalDistanceKm += feature.properties.distance;
      }
    }

    const speeds = {
      "Bicycle": 30,
      "Car": 80,
      "Leg": 10,
    };

    const travelTimesHTML = [];
    for (const mode in speeds) {
      const timeHours = totalDistanceKm / speeds[mode];
      travelTimesHTML.push(`<li>By ${mode}: ${timeHours.toFixed(2)} hours</li>`);
    }

    document.getElementById("total-distance").textContent = `${totalDistanceKm} km`;
    document.getElementById("travel-times").innerHTML = travelTimesHTML.join("");


shortestPathLayer= new ol.layer.Vector({
        source: new ol.source.Vector({
            features: features
            
        }),
        name:"shortest_path",
         style: new ol.style.Style({
    stroke: new ol.style.Stroke({
      color: '#00FF00', // Green for the shortest path
      width: 5
    })
  })
    });
  


    // Add the point layer to the map
    map.addLayer(shortestPathLayer);
    var currentZoom_ = map.getView().getZoom();
  // Assuming you have a map object named 'map'
var extent = ol.extent.createEmpty();

for (var i = 0; i < features.length; i++) {
  var feature = features[i];
  var geometry = feature.getGeometry();

  // Get the extent of each feature and extend the overall extent
  ol.extent.extend(extent, geometry.getExtent());
}

// Calculate the center of the combined extent
var center = ol.extent.getCenter(extent);

// Use the center coordinates as needed (e.g., to center your map)
// Set the center of the map to the selected point
map.getView().animate({
    center: center,
    zoom: currentZoom_ + 2, // You can adjust the zoom level here
    duration: 1000 // Duration of the animation in milliseconds
});
                       }

                    })
}
const service_styles = [
{
name: "Air Port",
fill: "#3fa6f2",
stroke: "#9d5c9e"
},
{
name: "Bank",
fill: "#7dc1eb",
stroke: "#a187c6"
},
{
name: "Beverage",
fill: "#bc8a3b",
stroke: "#c3cb79"
},
{
name: "Bus Terminal",
fill: "#dba71b",
stroke: "#69d5c1"
},
{
name: "Café",
fill: "#f284ad",
stroke: "#f5b0cc"
},
{
name: "Camp Site",
fill: "#79a855",
stroke: "#b1b9a9"
},
{
name: "Catholic Church",
fill: "#5a57bc",
stroke: "#e84b2e"
},
{
name: "Clinic",
fill: "#eb9b33",
stroke: "#2fd49d"
},
{
name: "College",
fill: "#b7a54e",
stroke: "#9a3f4d"
},
{
name: "Garage",
fill: "#cd6f8d",
stroke: "#f78e8b"
},
{
name: "Gas Station",
fill: "#ac6ac7",
stroke: "#d4c1ee"
},
{
name: "Health Center",
fill: "#79ad9e",
stroke: "#b2a65c"
},
{
name: "Health Post",
fill: "#e09a6d",
stroke: "#dc6dd1"
},
{
name: "Hospital",
fill: "#62928d",
stroke: "#ec5f98"
},
{
name: "Hotel",
fill: "#d5a655",
stroke: "#768c69"
},
{
name: "Lodge",
fill: "#c56d62",
stroke: "#da9f66"
},
{
name: "Mosque",
fill: "#7d5ecf",
stroke: "#57b6af"
},
{
name: "Municipal",
fill: "#c77864",
stroke: "#c4e79a"
},
{
name: "Museum",
fill: "#62c680",
stroke: "#b5527e"
},
{
name: "Office",
fill: "#6bb0f0",
stroke: "#c6736f"
},
{
name: "Open Market",
fill: "#d5d762",
stroke: "#cc4aa5"
},
{
name: "Orthodox Church",
fill: "#d2699d",
stroke: "#81dd6d"
},
{
name: "Pension",
fill: "#e2e55c",
stroke: "#5bcff1"
},
{
name: "Pharmacy",
fill: "#d766c9",
stroke: "#76856a"
},
{
name: "Police Station",
fill: "#669ecf",
stroke: "#b67667"
},
{
name: "Protestant Church",
fill: "#e0d25e",
stroke: "#5c85d2"
},
{
name: "Repair",
fill: "#61d49d",
stroke: "#e27298"
},
{
name: "Restaurant",
fill: "#cc858f",
stroke: "#98bd5f"
},
{
name: "School",
fill: "#7bd64e",
stroke: "#d452a8"
},
{
name: "Stadium",
fill: "#6587c7",
stroke: "#f7905a"
},
{
name: "Super Market",
fill: "#bc69e0",
stroke: "#5c8d60"
},
{
name: "University",
fill: "#e16a73",
stroke: "#68a363"
}
]

const destination_styles = [
{
name: "Cultural",
fill: "#5fccc",
stroke: "#6ffc9e"
},
{
name: "Man Made",
fill: "#7a899",
stroke: "blue"
},
{
name: "Natural",
fill: "#32ccc",
stroke: "red"
},
]

function getDynamicStyle(coord) {
    if(coord.whattype=="services"){
        const service_style = service_styles.find(style => style.name === coord.service_ty);
    
    if(service_style){
        return new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({color: service_style.fill}),
                stroke: new ol.style.Stroke({color: service_style.stroke, width: 2})
            })
        });
    }
    // If no matching style found, return a default style
    return new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({color: 'gray'}),
            stroke: new ol.style.Stroke({color: 'black', width: 2})
        })
    })
    }

    if(coord.whattype=="destinations"){
        const destination_style = destination_styles.find(style => style.name === coord.destinatio);
    
    if(destination_style){
        return new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({color: destination_style.fill}),
                stroke: new ol.style.Stroke({color: destination_style.stroke, width: 2})
            })
        });
    }
    // If no matching style found, return a default style
    return new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({color: 'gray'}),
            stroke: new ol.style.Stroke({color: 'black', width: 2})
        })
    })
    }

}
// Function to add markers to the map based on coordinates
        function addMarkersToMap(coordinates) {
            // Remove previous markers
            map.getLayers().forEach(layer => {
                if (layer.get('name') === 'markers') {
                    map.removeLayer(layer);
                }
            });
            

        

        // Create a style function
        function styleFunction(coord) {
           
            if(coord.whattype=="services"){
                return getDynamicStyle(coord)

            }
            if(coord.whattype=="destinations"){
                return getDynamicStyle(coord)
            }
            // Condition to apply different styles
           
        };

            // Create a vector layer for markers
            var markerLayer = new ol.layer.Vector({
                name: 'markers',
                source: new ol.source.Vector(),
                 
            });
    
            // Add markers to the layer
            coordinates.forEach(coord => {
                if(coord.whattype=="services"){
                    var marker = new ol.Feature({
                    geometry:  new ol.geom.Point([coord.x, coord.y]),
                    whattype: "services",
                    geom: coord.geom, 
                    objectid: coord.objectid, 
                    x: coord.x, 
                    y: coord.y, 
                    z: coord.z, 
                    code: coord.code, 
                    full_name: coord.full_name,
                    short_name: coord.short_name, 
                    zone: coord.zone,
                     wereda: coord.wereda, 
                     kebele: coord.kebele, 
                     phone_line: coord.phone_line,
                      email: coord.email, 
                      website: coord.website, 
                      service_ty: coord.service_ty,
                       owner_name: coord.owner_name, 
                       moto: coord.moto
                });
                marker.setStyle(styleFunction(coord))
                markerLayer.getSource().addFeature(marker);
                }
                if(coord.whattype=="destinations"){
                    var marker = new ol.Feature({
                    geometry:  new ol.geom.Point([coord.x, coord.y]),
                    geom: coord.geom,
                    whattype: "destinations",
    objectid: coord.objectid,
    name: coord.name,
    datetimes: coord.datetimes,
    elevation: coord.elevation,
    code: coord.code,
    full_name: coord.full_name,
    short_name: coord.short_name,
    zone: coord.zone,
    wereda: coord.wereda,
    kebele: coord.kebele,
    locality_n: coord.locality_n,
    organizati: coord.organizati,
    destinatio: coord.destinatio,
    status: coord.status,
    area_sqkm: coord.area_sqkm,
    yearly_est: coord.yearly_est,
    unesco_reg: coord.unesco_reg,
    descriptio: coord.descriptio,
    photo_no: coord.photo_no,
    photo_loca: coord.photo_loca,
    site_des_a: coord.site_des_a,
    amharic: coord.amharic,
    english: coord.english,
    x: coord.x,
    y: coord.y,
    image1: coord.image1,
    image2: coord.image2
                });
                marker.setStyle(styleFunction(coord))
                markerLayer.getSource().addFeature(marker);
                }
                
                
            });
    
            // Add the marker layer to the map
            map.addLayer(markerLayer);
            
            function getFeaturesExtent(vectorLayer) {
                
            let extent = null;
            vectorLayer.getSource().forEachFeature(function(feature) {
                console.log("ppppp",feature)
                const featureGeometry = feature.getGeometry();
                const featureExtent = featureGeometry.getExtent();
                
                if (!extent) {
                extent = featureExtent.slice(); // Create a copy to avoid modification
                } else {
                extent = ol.extent.extend(extent, featureExtent);
                }
            });
            return extent;
            }

            const featuresExtent = getFeaturesExtent(markerLayer);

            const center = ol.extent.getCenter(featuresExtent);
            
            map.getView().animate({
            center:center,
            extent: featuresExtent,
            zoom: currentZoom + 5, 
            duration: 500 // Set the desired animation duration

            });

        }
    
        $(document).ready(function () {
            
            $('.collapse-icon').click(function (event) {
                event.stopPropagation();
                $(this).toggleClass('bi-chevron-right bi-chevron-down');
                var $ul = $(this).siblings('ul');
                if ($ul.length > 0) {
                    $ul.toggle();
                }
            });
    
            function getCheckedLeafNodes($node) {
                var checkedLeafNodes = [];
                $node.find(':checkbox:checked').each(function () {
                    var $checkbox = $(this);
                    if ($checkbox.siblings('ul').length === 0) {
                        if($checkbox.data('whattype')=="services")
                        {
                            checkedLeafNodes.push({
    id: $checkbox.attr('id'),
    whattype: $checkbox.data('whattype'),
    geom: $checkbox.data('geom'),
    objectid: $checkbox.data('objectid'),
    x: $checkbox.data('x'),
    y: $checkbox.data('y'),
    z: $checkbox.data('z'),
    code: $checkbox.data('code'),
    full_name: $checkbox.data('full_name'),
    short_name: $checkbox.data('short_name'),
    zone: $checkbox.data('zone'),
    wereda: $checkbox.data('wereda'),
    kebele: $checkbox.data('kebele'),
    phone_line: $checkbox.data('phone_line'),
    email: $checkbox.data('email'),
    website: $checkbox.data('website'),
    service_ty: $checkbox.data('service_ty'),
    owner_name: $checkbox.data('owner_name'),
    moto: $checkbox.data('moto')
});
                        }
                        if($checkbox.data('whattype')=="destinations")
                        {
                            checkedLeafNodes.push({
    id: $checkbox.attr('id'),
    whattype: $checkbox.data('whattype'),
    geom: $checkbox.data('geom'),
    objectid: $checkbox.data('objectid'),
    name: $checkbox.data('name'),
    datetimes: $checkbox.data('datetimes'),
    elevation: $checkbox.data('elevation'),
    code: $checkbox.data('code'),
    full_name: $checkbox.data('full_name'),
    short_name: $checkbox.data('short_name'),
    zone: $checkbox.data('zone'),
    wereda: $checkbox.data('wereda'),
    kebele: $checkbox.data('kebele'),
    locality_n: $checkbox.data('locality_n'),
    organizati: $checkbox.data('organizati'),
    destinatio: $checkbox.data('destinatio'),
    status: $checkbox.data('status'),
    area_sqkm: $checkbox.data('area_sqkm'),
    yearly_est: $checkbox.data('yearly_est'),
    unesco_reg: $checkbox.data('unesco_reg'),
    descriptio: $checkbox.data('descriptio'),
    photo_no: $checkbox.data('photo_no'),
    photo_loca: $checkbox.data('photo_loca'),
    site_des_a: $checkbox.data('site_des_a'),
    amharic: $checkbox.data('amharic'),
    english: $checkbox.data('english'),
    x: $checkbox.data('x'),
    y: $checkbox.data('y'),
    image1: $checkbox.data('image1'),
    image2: $checkbox.data('image2')
});
                        }
                    }
                });
    
                $node.find('ul').each(function () {
                    var childLeafNodes = getCheckedLeafNodes($(this));
                    checkedLeafNodes = checkedLeafNodes.concat(childLeafNodes);
                });
    
                return checkedLeafNodes;
            }
    
            function toggleChildren($parentCheckbox) {
                var isChecked = $parentCheckbox.prop('checked');
                $parentCheckbox.siblings('ul').find(':checkbox').prop('checked', isChecked);
            }
    
            
            $('.tree-view :checkbox').change(function () {
                var $parentCheckbox = $(this);
                toggleChildren($parentCheckbox);
                // Get checked leaf nodes after toggling children
                var checkedLeafNodes = getCheckedLeafNodes($parentCheckbox.closest('ul'));

                // Add markers to the map based on checked coordinates
                addMarkersToMap(checkedLeafNodes);
            });
    
            // Trigger checkbox change event on page load to display checked points
            $('.tree-view :checkbox:checked').trigger('change');
        });
        var googleSatelliteSource = new ol.source.XYZ({
    url: 'http://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'
});

// Define the Google Satellite layer
var googleSatelliteLayer = new ol.layer.Tile({
    source: googleSatelliteSource,
    name: 'Google Satellite'
});
        var vectorSource = new ol.source.Vector({
    format: new ol.format.GeoJSON(),
    url: function(extent) {
        return 'http://localhost:8080/geoserver/routing/ows?service=WFS&' +
            'version=1.0.0&request=GetFeature&typeName=routing%3Aprojectedsouthomo&' +
            'maxFeatures=90000&outputFormat=application%2Fjson';
    },
    strategy: ol.loadingstrategy.bbox
});

// Define the vector layer
var vectorLayer = new ol.layer.Vector({
    source: vectorSource,
    name: 'GeoJSON Layer'
});
        var map = new ol.Map({
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM(),
                    name: 'OSM'
                }),
                googleSatelliteLayer,
                vectorLayer,
            ],
            target: 'map-canvas',
            controls: ol.control.defaults({
                attributionOptions: ({
                    collapsible: false
                })
            }),
            view: new ol.View({
                center: [37, 8],
                zoom: 5,
                projection: 'EPSG:4326'
            })
        });
        var layerSwitcher = new ol.control.LayerSwitcher({
            tipLabel: 'Layer Switcher',
            //reverse: true,
            groupSelectStyle: 'group'
        });
    
        map.addControl(layerSwitcher);
        var currentZoom = map.getView().getZoom();
        map.on('singleclick', function (evt) {
    map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
        if (feature) {
            var properties = feature.getProperties();
            var overlay = document.getElementById('property-overlay');
            var overlay2 = document.getElementById('property-overlay2');
            var closeBtn = document.createElement('span');
            var closeBtn2 = document.createElement('span');
            closeBtn.className = 'close-btn';
            closeBtn.innerHTML = '&#10006;'; // Close icon (you can use an appropriate icon)

            closeBtn2.className = 'close-btn';
            closeBtn2.innerHTML = '&#10006;'; // Close icon (you can use an appropriate icon)


           
            for (var key in properties) {
                if (properties.whattype == "services") {
                    $(overlay).removeClass("d-none")
                    $(overlay2).addClass("d-none")
                    
                    if (key === 'full_name' || key === 'zone' || key === 'wereda' || key === 'kebele' || key === 'phone_line' || key === 'email' || key === 'service_ty' || key === 'owner_name' || key === 'moto') {
                        properties[key]==null?$("#"+key+"-label").text('-') :$("#"+key+"-label").text(properties[key]) 
                    }
                }
                if (properties.whattype == "destinations") {
                    $(overlay2).removeClass("d-none")
                    $(overlay).addClass("d-none")
                    if (key === 'full_name' || key === 'zone' || key === 'wereda' || key === 'kebele' || key === 'destinatio' || key === 'area_sqkm' || key === 'yearly_est' || key === 'unesco_reg' || key === 'photo_no' || key === 'photo_loca' || key === 'amharic' || key === 'english' ) {
                        properties[key]==null||properties[key]=="None"?$("#"+key+"-label2").text('-') :$("#"+key+"-label2").text(properties[key]) 
                    }
                    if (key === 'image1' ) {
                        if(properties[key]=="None"){
                            properties[key]==null?$("#"+key+"-label2").text('-') :$("#"+key+"-label2").text('-') 

                        }
                        else{
                            console.log(key)
                            console.log($("#"+key+"-label2"))
                            
                            properties[key]==null?$("#"+key+"-label2").attr('src','/media/'+properties[key]) :$("#"+key+"-label2").attr('src','/media/'+properties[key])
                            
                        }
                        }
                        if (key === 'image2') {
                       
                       if(properties[key]=="None"){
                        properties[key]==null?$("#"+key+"-label2").text('-') :$("#"+key+"-label2").text('-') 

                       }
                       else{
                        properties[key]==null?$("#"+key+"-label2").attr('src','/media/'+properties[key]) :$("#"+key+"-label2").attr('src','/media/'+properties[key])

                       }
                       }
                }
            }

           

            // Add close button
            overlay.appendChild(closeBtn);
            overlay2.appendChild(closeBtn2);

            // Position the overlay beside the feature
            var pixel = map.getPixelFromCoordinate(feature.getGeometry().getCoordinates());
            var mapCanvas = document.getElementById('map-canvas');
            overlay.style.left = (mapCanvas.offsetLeft + pixel[0] + 10) + 'px'; // Adjust offset as needed
            overlay.style.top = (mapCanvas.offsetTop + pixel[1]) + 'px'; // Adjust offset as needed

            // Show the overlay
            overlay.style.display = 'block';
            overlay2.style.left = (mapCanvas.offsetLeft + pixel[0] + 10) + 'px'; // Adjust offset as needed
            overlay2.style.top = (mapCanvas.offsetTop + pixel[1]) + 'px'; // Adjust offset as needed

            // Show the overlay2
            overlay2.style.display = 'block';

            // Close overlay when close button is clicked
            closeBtn.addEventListener('click', function () {
                overlay.style.display = 'none';

            });
            closeBtn2.addEventListener('click', function () {
                overlay2.style.display = 'none';

            });

        } else {
            // Hide the overlay if no feature found
            document.getElementById('property-overlay').style.display = 'none';
            document.getElementById('property-overlay2').style.display = 'none';

        }
    });
});

// Adjust the overlay's position when the map view changes
map.on('moveend', function () {
    var overlay = document.getElementById('property-overlay');
    var visible = overlay.style.display === 'block';
    var overlay2 = document.getElementById('property-overlay2');
    var visible = overlay2.style.display === 'block';
    if (visible) {
        var feature = getFeatureUnderOverlay();
        if (feature) {
            var pixel = map.getPixelFromCoordinate(feature.getGeometry().getCoordinates());
            var mapCanvas = document.getElementById('map-canvas');
            overlay.style.left = (mapCanvas.offsetLeft + pixel[0] + 10) + 'px'; // Adjust offset as needed
            overlay.style.top = (mapCanvas.offsetTop + pixel[1]) + 'px'; // Adjust offset as needed
            overlay2.style.left = (mapCanvas.offsetLeft + pixel[0] + 10) + 'px'; // Adjust offset as needed
            overlay2.style.top = (mapCanvas.offsetTop + pixel[1]) + 'px'; // Adjust offset as needed
        } else {
            overlay.style.display = 'none';
            overlay2.style.display = 'none';
        }
    }
});

// Helper function to get the feature under the overlay
function getFeatureUnderOverlay() {
    // Get the pixel position of the overlay
    var overlay = document.getElementById('property-overlay');
    var overlay2 = document.getElementById('property-overlay2');

    var left = parseFloat(overlay.style.left);
    var top = parseFloat(overlay.style.top);
    var left2 = parseFloat(overlay2.style.left);
    var top2 = parseFloat(overlay2.style.top);
    var pixel = [left, top];
    var pixel2 = [left2, top2];

    // Convert pixel position to map coordinate
    var coordinate = map.getCoordinateFromPixel(pixel);
    var coordinate2 = map.getCoordinateFromPixel(pixel2);
    // Get the feature at the coordinate
    var feature = map.forEachFeatureAtPixel(pixel, function (feature, layer) {
        return feature;
    });

    return feature;
}
 </script>
    
    
 
</body>

</html>