{%extends "../new/base-2.html" %}
{%block content %}
{% include '../new/navbar-2.html' %}
{% load static %}
{% load custom_tags %}

<style>
.offcanvas {
    background-color: #fff;
    }
.offcanvas-header {
  font-family: 'Nexa-Book' sans-serif;
    display: flex;
    background-color: #BF4747;
    color: #fff;
    align-items: center;
    justify-content: space-between;
    padding: var(--bs-offcanvas-padding-y) var(--bs-offcanvas-padding-x);
}
.offcanvas-header h5 {
    font-weight: bold;
}

.offcanvas.offcanvas-end {
    top: 84px!important;
    width: 25%!important;
    border: 1px solid #0aa8d4;
}
.offcanvas-body {
    flex-grow: 1;
    padding: var(--bs-offcanvas-padding-y) var(--bs-offcanvas-padding-x);
    overflow-y: auto;
}
#autocomplete-input {
            position: absolute;
            width: 100%;
  right:  120%;

            z-index: 1000; /* Ensure the autocomplete is above the map */
        }
        .autocomplete1 {
        

            z-index: 1000; /* Ensure the autocomplete is above the map */
        }
        .autocomplete2 {
        

            z-index: 1000; /* Ensure the autocomplete is above the map */
        }
      
        .overlay-btn {
            position: absolute;
  z-index: 555555555;
            top: 21px;
            float: right;

        }
        .ui-menu {
            z-index: 2147483647;
  display: none;
  position: relative;
  top: -442.383px;
  left: 3px;
  overflow: scroll;
  height: 100px;
  background-color: aquamarine;
  width: 20% !important;
}

</style>

<div class="modal fade" id="serviceInfoModal" tabindex="-1" aria-labelledby="serviceInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" id="modalContent">
        </div>
    </div>
  </div>
 
<section class="container-fluid mt-4 full-landing">
   
    <div id="map" class="map">  
        <button class="btn btn-primary overlay-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
            <i class="bi bi-stack"></i>
        </button>
    </div>
</section>


<div class="offcanvas offcanvas-end show" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasRightLabel">Layers</h5>
    <!-- <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button> -->
  </div>
  <div class="offcanvas-body">
    <div class="row">


        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill"
                    data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home"
                    aria-selected="true">Catalog</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-routing-tab" data-bs-toggle="pill"
                    data-bs-target="#pills-routing" type="button" role="tab" aria-controls="pills-routing"
                    aria-selected="false">Routing</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-charts-tab" data-bs-toggle="pill"
                    data-bs-target="#pills-charts" type="button" role="tab" aria-controls="pills-charts"
                    aria-selected="false">Charts</button>
            </li>
        </ul>
        <div class="tab-content" id="pills-tabContent">
            <div class="row" style="justify-content: center;">
                <button class="btn btn-primary col-3" onclick="location.reload()">clear</button>
            </div>
            <br>
            <div class="tab-pane fade show active" id="pills-home" role="tabpanel"
                aria-labelledby="pills-home-tab">
                <ul id="treeview" class="tree-view">
                    <li>
                        <span class="collapse-icon bi bi-chevron-right" data-toggle="collapse" data-target="#step1"></span>
                        <input type="checkbox" id="step1" />
                        <label for="step1">Services ({{combined_data.services.count}})</label>
                
                        <ul id="step1" class="collapse">
                          

                            {% for service_info in combined_data.services|get_distinct_service_ty_info %}
                            <li>
                                <span class="collapse-icon bi bi-chevron-right" data-toggle="collapse" data-target="#{{ service_info.service_type }}"></span>
                                <input type="checkbox" id="{{ service_info.service_type }}" data-x="{{ obj.x }}" data-y="{{ obj.y }}"> <label for="{{ service_info.service_type }}">{{ service_info.service_type }}</label>
                                {% if service_info.service_type == "Air Port" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Bank" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Beverage" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Bus Terminal" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Café" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Camp Site" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Catholic Church" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Clinic" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "College" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Garage" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Gas Station" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Health Center" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Health Post" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Hospital" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Hotel" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Lodge" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Mosque" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Municipal" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Museum" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Office" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Open Market" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Orthodox Church" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Pension" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Pharmacy" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Police Station" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Protestant Church" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "Repair" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Restaurant" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "School" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Stadium" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% elif service_info.service_type == "Supper Market" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})
                                    {% elif service_info.service_type == "University" %}
                                    <i class="bi bi-person-hearts"></i> ({{ service_info.count }})

                                    {% endif %}
                                <ul id="{{ service_info.service_type }}" class="collapse">
                                    {% for obj in service_info.objects %}
                                        <li>
                                            <input type="checkbox" id="{{ obj.id }}" 
                                                                                    data-whatType="services" 
                                                                                    data-geom="{{ obj.geom }}" 
                                    data-objectid="{{ obj.objectid }}" 
                                    data-x="{{ obj.x }}" 
                                    data-y="{{ obj.y }}"
                                    data-z="{{ obj.z }}"
                                    data-code="{{ obj.code }}"
                                    data-full_name="{{ obj.full_name }}"
                                    data-short_name="{{ obj.short_name }}"
                                    data-zone="{{ obj.zone }}"
                                    data-wereda="{{ obj.wereda }}"
                                    data-kebele="{{ obj.kebele }}"
                                    data-phone_line="{{ obj.phone_line }}"
                                    data-email="{{ obj.email }}"
                                    data-website="{{ obj.website }}"
                                    data-service_ty="{{ obj.service_ty }}"
                                    data-owner_name="{{ obj.owner_name }}"
                                    data-moto="{{ obj.moto }}"
                                    > <label for="{{ obj.id }}" style="font-size: 13px;">{{ obj.full_name }}</label>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                        </ul>
                    </li>
                  {% csrf_token %}

                    <li>
                        <span class="collapse-icon bi bi-chevron-right" data-toggle="collapse" data-target="#step1"></span>
                        <input type="checkbox" id="step1" />
                        <label for="step1">Attraction Site({{combined_data.destinations.count}})</label>
                
                        <ul id="step1" class="collapse">
                           
                            {% for destibnation_info in combined_data.destinations|get_distinct_destinations_ty_info %}
                            <li>
                                <span class="collapse-icon bi bi-chevron-right" data-toggle="collapse" data-target="#{{ destibnation_info.destinatio }}"></span>
                                <input type="checkbox" 
                                id="{{ destibnation_info.destinatio }}" 
                               >{{ destibnation_info.destination_type }}</label>
                                {% if destibnation_info.destination_type == "Cultural" %}
                                <i class="bi bi-person-hearts"></i>  {% elif destibnation_info.destination_type == "Man Made" %}
                                <i class="bi bi-person-hearts"></i>  {% elif destibnation_info.destination_type == "Natural" %}
                                <i class="bi bi-person-hearts"></i>  {% endif %}
                                ({{ destibnation_info.count }})                                    
                                <ul id="{{ destibnation_info.destinatio }}" class="collapse">
                                    {% for obj in destibnation_info.objects %}
                                    {{obj.full}}
                                        <li>
                                            <input type="checkbox" id="{{ obj.id }}" 
                                            data-whatType="destinations" 
                                            data-geom="{{ obj.geom }}" 
                                            data-objectid="{{ obj.objectid }}" 
                                            data-name="{{ obj.name }}" 
                                            data-datetimes="{{ obj.datetimes }}" 
                                            data-elevation="{{ obj.elevation }}" 
                                            data-code="{{ obj.code }}" 
                                            data-full_name="{{ obj.full_name }}" 
                                            data-short_name="{{ obj.short_name }}" 
                                            data-zone="{{ obj.zone }}" 
                                            data-wereda="{{ obj.wereda }}" 
                                            data-kebele="{{ obj.kebele }}" 
                                            data-locality_n="{{ obj.locality_n }}" 
                                            data-organizati="{{ obj.organizati }}" 
                                            data-destinatio="{{ obj.destinatio }}" 
                                            data-status="{{ obj.status }}" 
                                            data-area_sqkm="{{ obj.area_sqkm }}" 
                                            data-yearly_est="{{ obj.yearly_est }}" 
                                            data-unesco_reg="{{ obj.unesco_reg }}" 
                                            data-descriptio="{{ obj.descriptio }}" 
                                            data-photo_no="{{ obj.photo_no }}" 
                                            data-photo_loca="{{ obj.photo_loca }}" 
                                            data-site_des_a="{{ obj.site_des_a }}" 
                                            data-amharic="{{ obj.amharic }}" 
                                            data-english="{{ obj.english }}" 
                                            data-x="{{ obj.x }}" 
                                            data-y="{{ obj.y }}" 
                                            data-image1="{{ obj.image1 }}" 
                                            data-image2="{{ obj.image2 }}">    
                                            <label for="{{ obj.destinatio }}"
                                            > <label for="{{ obj.id }}" style="font-size: 13px;">{{ obj.full_name }}</label>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                        </ul>
                    </li>
                </ul>
                
                
                
            </li>
           
                </ul>
            </div>
            <div class="tab-pane fade" id="pills-routing" role="tabpanel" aria-labelledby="pills-routing-tab">
                <div class="form-group">
                  <input type="text"  class="form-control mr-sm-2 autocomplete1 "  id="sourceLocation" placeholder="Enter source location" autocomplete="off">
                </div>
                <br>
                <div class="form-group">
                  <input type="text"  class="form-control mr-sm-2 autocomplete2 "  id="targetLocation" placeholder="Enter target location" autocomplete="off">
                </div>
                <br>
                <button class="btn btn-primary" onclick="makeRoute()">Route</button>
               
                <div class="container mt-3">
                    <h3>Shortest Distance Calculator</h3>
                    <hr>
                    <div class="row">
                      <div class="col-sm-6">
                        <h5>Total Distance:</h5>
                        <p id="total-distance-km"></p>
                        <p id="total-distance-miles"></p>
                        <p id="total-distance-feet"></p>
                      </div>
                      <div class="col-sm-6">
                        <h5>Travel Times:</h5>
                        <ul id="travel-times">
                        </ul>
                      </div>
                    </div>
                  </div>
               </div>
               <div class="tab-pane fade" id="pills-charts" role="tabpanel" aria-labelledby="pills-charts-tab">
               
                <br>
             <!-- Nav tabs -->
<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab" aria-controls="services" aria-selected="true">Services</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="attraction-site-tab" data-bs-toggle="tab" data-bs-target="#attraction-site" type="button" role="tab" aria-controls="attraction-site" aria-selected="false">Attraction Site</button>
    </li>
    
  </ul>
  
  <!-- Tab panes -->
  <div class="tab-content">
    <div class="tab-pane active" id="services" role="tabpanel" aria-labelledby="services-tab">
        <div class="row">
            <canvas id="myChart"></canvas>
        </div>
      
    </div>
    <div class="tab-pane" id="attraction-site" role="tabpanel" aria-labelledby="attraction-site-tab">
        <div class="row">
            <div class="row">
                <canvas id="desChart"></canvas>
            </div>
        </div>
    </div>
  </div>
  
               </div>

        </div>


 
</div>
  </div>
</div>
<script src="{% static 'src/ol3-layerswitcher.js' %}"></script>
<script src="{% static 'layerswitcher.js' %}"></script>
<script src="{% static 'js/jquery-1.10.2.min.js'%}"></script>
<script src="{% static 'jquery-ui.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    
    var distinct_destinations = "{{ distinct_destinations | escapejs}}";
    var distinct_services = "{{ distinct_services | escapejs}}";
    const service_label = JSON.parse(distinct_services).map(x=>x.service_ty)
    const service_data = JSON.parse(distinct_services).map(x=>x.count)

    const destinations_label = JSON.parse(distinct_destinations).map(x=>x.destinatio)
    const destinations_data = JSON.parse(distinct_destinations).map(x=>x.count)    
    const ctx = document.getElementById('myChart');
  
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: service_label,
        datasets: [{
          label: 'Services',
          data: service_data,
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    
    const ctx2 = document.getElementById('desChart');
  
    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: destinations_label,
        datasets: [{
          label: 'Destinations',
          data: destinations_data,
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
   
  </script>
  
<script>
    

    var googleSatelliteSource = new ol.source.XYZ({
        url: 'http://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'
    });
    new ol.layer.Tile({
        source: googleSatelliteSource,
        name: 'Google Satellite',
        type: 'base',
        visible: true,
    })
var omoBoundary=JSON.parse('{{boundary|escapejs }}')
console.log(omoBoundary[0].coordinates[0][0])
    // Create a GeoJSON format instance
const geojsonFormat = new ol.format.GeoJSON();

// Parse the GeoJSON-like data


// Convert GeoJSON-like data to OpenLayers Feature
const feature3 = geojsonFormat.readFeature(omoBoundary[0]);
console.log(omoBoundary[0])
const vectorSource = new ol.source.Vector({
  features: [feature3],
  format: geojsonFormat,
  strategy: ol.loadingstrategy.bbox
});

    // Define a style function to dynamically set color based on feature properties (optional)
var styleFunction = function(feature) {
    // Access feature properties (if applicable) and assign color based on logic
    var color = feature.get('someProperty') ? 'blue' : 'red'; // Example

    return new ol.style.Style({
        stroke: new ol.style.Stroke({
            color: "#00FFFF",
            width: 2
        }),
      
    });
};
    
         
    
    // Define the vector layer
    var vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        title: 'Gamo and South Omo Boundary',
        visible:false,
        style: styleFunction 
    });  
    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Group({
                'title': 'Base maps',
                layers: [
                    
                new ol.layer.Tile({
                        title: 'Google Satelite',
                        type: 'base',
                        visible: true,
                        source: googleSatelliteSource,
                    }),
                    new ol.layer.Tile({
                        title: 'OSM',
                        type: 'base',
                        visible: true,
                        source: new ol.source.OSM()
                    }),
                   
                    
                    
                ]
            }),
            new ol.layer.Group({
                title: 'Overlays',
                layers: [
                    vectorLayer
                ]
            })
        ],
        view: new ol.View({
            center: [41,8],
                zoom: 7,
                projection: 'EPSG:4326'
        })
    });

    var layerSwitcher = new ol.control.LayerSwitcher({
        tipLabel: 'Légende' // Optional label for button
    });
    map.addControl(layerSwitcher);
    var currentZoom = map.getView().getZoom();
      function makeRoute(){
        $.ajax({
                headers: { "X-CSRFToken": '{{ csrf_token }}' },
                url: '{% url "main:shortest_path"  %}',
                data: { source: source,target:target },
                type: "POST",
                success: function (data) {
                    var format = new ol.format.GeoJSON();
                        var features = format.readFeatures(data, {
                        featureProjection: 'EPSG:4326'
                        });
                        let totalDistanceKm = 0;
    for (const feature of data.features) {
      if (feature.properties && feature.properties.distance) {
        totalDistanceKm += feature.properties.distance;
      }
    }

    const speeds = {
      "Bicycle": 30,
      "Car": 80,
      "Leg": 10,
    };

    const travelTimesHTML = [];
    for (const mode in speeds) {
      const timeHours = totalDistanceKm / speeds[mode];
      travelTimesHTML.push(`<li>By ${mode}: ${timeHours.toFixed(2)} hours</li>`);
    }
    function convertAndRound(distanceKm, conversionFactor, unitSymbol) {
  const convertedValue = distanceKm * conversionFactor;
  return convertedValue.toFixed(2) + ' ' + unitSymbol;
}

const distanceInMiles = convertAndRound(totalDistanceKm, 0.621371, 'mi');
const distanceInFeet = convertAndRound(totalDistanceKm, 3280.84, 'ft');



    document.getElementById("total-distance-km").textContent = `${totalDistanceKm.toFixed(2)} km`;
    document.getElementById("total-distance-miles").textContent = `${distanceInMiles}`;
    document.getElementById("total-distance-feet").textContent = `${distanceInFeet} `;
    
    document.getElementById("travel-times").innerHTML = travelTimesHTML.join("");


shortestPathLayer= new ol.layer.Vector({
        source: new ol.source.Vector({
            features: features
            
        }),
        name:"shortest_path",
         style: new ol.style.Style({
    stroke: new ol.style.Stroke({
      color: '#00FF00', // Green for the shortest path
      width: 5
    })
  })
    });
  


    // Add the point layer to the map
    map.addLayer(shortestPathLayer);
    var currentZoom_ = map.getView().getZoom();
  // Assuming you have a map object named 'map'
var extent = ol.extent.createEmpty();

for (var i = 0; i < features.length; i++) {
  var feature = features[i];
  var geometry = feature.getGeometry();

  // Get the extent of each feature and extend the overall extent
  ol.extent.extend(extent, geometry.getExtent());
}

// Calculate the center of the combined extent
var center = ol.extent.getCenter(extent);
map.getView().animate({
    center: center,
    zoom: currentZoom_ - 1, // You can adjust the zoom level here
    duration: 1000 // Duration of the animation in milliseconds
});
                        
                },
                error: function (data) {
                    // Handle error
                }
            });
  
}
      
    map.on('singleclick', function (evt) {
  map.forEachFeatureAtPixel(evt.pixel, function (feature, layer) {
    if (feature) {
      var properties = feature.getProperties();

      // Check feature type (services or destinations)
      if (properties.whattype === "services") {
        var serviceInfo = `
          <h4>Service Details</h4>
          <ul>
            <li><b>Full Name:</b> ${properties.full_name || 'N/A'}</li>
            <li><b>Zone:</b> ${properties.zone || 'N/A'}</li>
            <li><b>Wereda:</b> ${properties.wereda || 'N/A'}</li>
            <li><b>Kebele:</b> ${properties.kebele || 'N/A'}</li>
            <li><b>Phone Line:</b> ${properties.phone_line || 'N/A'}</li>
            <li><b>Email:</b> ${properties.email || 'N/A'}</li>
            <li><b>Service Type:</b> ${properties.service_ty || 'N/A'}</li>
            <li><b>Owner Name:</b> ${properties.owner_name || 'N/A'}</li>
            <li><b>Moto:</b> ${properties.moto || 'N/A'}</li>
          </ul>
        `;
      } else if (properties.whattype === "destinations") {
        var destinationInfo = `
          <h4>Destination Details</h4>
          <ul>
            <li><b>Full Name:</b> ${properties.full_name || 'N/A'}</li>
            <li><b>Zone:</b> ${properties.zone || 'N/A'}</li>
            <li><b>Wereda:</b> ${properties.wereda || 'N/A'}</li>
            <li><b>Kebele:</b> ${properties.kebele || 'N/A'}</li>
            <li><b>Destination:</b> ${properties.destinatio || 'N/A'}</li>
            <li><b>Area (sqkm):</b> ${properties.area_sqkm || 'N/A'}</li>
            <li><b>Yearly Estimate:</b> ${properties.yearly_est || 'N/A'}</li>
            <li><b>UNESCO Registration:</b> ${properties.unesco_reg || 'N/A'}</li>
            <li><b>Photo Number:</b> ${properties.photo_no || 'N/A'}</li>
            <li><b>Photo Location:</b> ${properties.photo_loca || 'N/A'}</li>
            <li><b>Amharic Description:</b> <textarea disabled row="6" style="overflow:scroll;">${properties.amharic || 'N/A'}</textarea></li>
            <li><b>English Description:</b> <textarea disabled style="overflow:scroll;">${properties.english || 'N/A'}</textarea></li>
          
                    ${properties.image1 ? `<img style="position: relative; width: 40%;" src="/media/${properties.image1}" alt="Image 1">` : ''}
                    
                    ${properties.image2 ? `<img style="position: relative; width: 40%;" src="/media/${properties.image2}" alt="Image 2">` : ''}
                   
          </ul>
        `;
      }

      // Create and display modal content dynamically
      var modalContent = document.getElementById('modalContent');
      if (serviceInfo) {
        modalContent.innerHTML = serviceInfo;
      } else if (destinationInfo) {
        modalContent.innerHTML = destinationInfo;
      } else {
        modalContent.innerHTML = 'No information available for this feature.';
      }

      $('#serviceInfoModal').modal('show'); // Assuming you have a modal with ID 'serviceInfoModal'
    }
  });
});


   // Enable Bootstrap Popovers
   var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
   var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
     return new bootstrap.Popover(popoverTriggerEl);
   });
   $(function() {
        
        var combinedData = JSON.parse("{{ combined_data_autocomplete|escapejs }}");
      
        var availableTags = [];
        // Combine service and destination full names into a single array
        combinedData.services.forEach(function(service) {
            availableTags.push({ label: service.full_name, value: service.full_name,
             whattype:"services",
            geom: service.geom, 
                          objectid: service.objectid, 
                          x: service.x, 
                          y: service.y, 
                          z: service.z, 
                          code: service.code, 
                          full_name: service.full_name,
                          short_name: service.short_name, 
                          zone: service.zone,
                           wereda: service.wereda, 
                           kebele: service.kebele, 
                           phone_line: service.phone_line,
                            email: service.email, 
                            website: service.website, 
                            service_ty: service.service_ty,
                             owner_name: service.owner_name, 
                             moto: service.moto
            
          });
        });
        combinedData.destinations.forEach(function(destination) {
            availableTags.push({ label: destination.full_name, value: destination.full_name,
              whattype:"destinations",
            geom: destination.geom,
          objectid: destination.objectid,
          name: destination.name,
          datetimes: destination.datetimes,
          elevation: destination.elevation,
          code: destination.code,
          full_name: destination.full_name,
          short_name: destination.short_name,
          zone: destination.zone,
          wereda: destination.wereda,
          kebele: destination.kebele,
          locality_n: destination.locality_n,
          organizati: destination.organizati,
          destinatio: destination.destinatio,
          status: destination.status,
          area_sqkm: destination.area_sqkm,
          yearly_est: destination.yearly_est,
          unesco_reg: destination.unesco_reg,
          descriptio: destination.descriptio,
          photo_no: destination.photo_no,
          photo_loca: destination.photo_loca,
          site_des_a: destination.site_des_a,
          amharic: destination.amharic,
          english: destination.english,
          x: destination.x,
          y: destination.y,
          image1: destination.image1,
          image2: destination.image2  });
        });
        var pointLayerSource;

$("#sourceLocation").autocomplete({
    source: availableTags,
    select: function(event, ui) {
        // Clear previous pointLayer if exists
        if (pointLayerSource) {
            map.removeLayer(pointLayerSource);
        }
        const layers = map.getLayers();


// Find the layer by name:
const shortestPathLayer = layers.getArray().find(layer => layer.get('name') === 'shortest_path');
if (shortestPathLayer) {
  map.removeLayer(shortestPathLayer)
} else {
  console.error('Layer with name "shortest_path" not found on the map.');
}
        var selectedItem = ui.item;
if (selectedItem.hasOwnProperty('x') && selectedItem.hasOwnProperty('y')) {
    var pointFeature = new ol.Feature();

    
        $.ajax({
                headers: { "X-CSRFToken": '{{ csrf_token }}' },
                url: '{% url "main:getNearstVertex"  %}',
                data: { selectedItem: JSON.stringify(selectedItem) },
                type: "POST",
                success: function (data) {
                    source=data.properties.id
                            pointFeature.setGeometry(new ol.geom.Point([data.geometry.coordinates[0], data.geometry.coordinates[1]]));
                            for (var key in Object.entries(data.properties)) {
                                pointFeature.set(Object.entries(data.properties)[key][0], Object.entries(data.properties)[key][1]);
                            }
                        
                },
                error: function (data) {
                    // Handle error
                }
            });
    
 

    // Create a vector layer to hold the point feature
    pointLayerSource = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [pointFeature],
            
        }),
        style:new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({color: "red"}),
                stroke: new ol.style.Stroke({color: "blue", width: 2})
            })
        })
    });
    

    // Add the point layer to the map
    map.addLayer(pointLayerSource);

    // Get the current zoom level
    var currentZoom_ = map.getView().getZoom();

    // Set the center of the map to the selected point
    var center = [selectedItem.x, selectedItem.y];
    map.getView().animate({
        center: center,
        zoom: currentZoom_ + 2, // You can adjust the zoom level here
        duration: 1000 // Duration of the animation in milliseconds
    });

        } else {
            console.warn("Selected item doesn't have x and y coordinates");
        }
    }
});

       
        var pointLayer; // Declare pointLayer outside the select event handler to maintain reference
        $("#autocomplete-input").autocomplete({
          source: availableTags,
          select: function(event, ui) {
              // Clear previous pointLayer if exists
              if (pointLayer) {
                  map.removeLayer(pointLayer);
              }
              // Get the selected item data
              var selectedItem = ui.item;
      
      // Check if x and y coordinates exist
      if (selectedItem.hasOwnProperty('x') && selectedItem.hasOwnProperty('y')) {
          var pointFeature = new ol.Feature();
      
              
      pointFeature.setGeometry(new ol.geom.Point([selectedItem.x, selectedItem.y]));
      for (var key in Object.entries(selectedItem)) {
                                pointFeature.set(Object.entries(selectedItem)[key][0], Object.entries(selectedItem)[key][1]);
                            }
    
      
     
          // Create a vector layer to hold the point feature
          pointLayer = new ol.layer.Vector({
              source: new ol.source.Vector({
                  features: [pointFeature],
                  
              }),
              style:new ol.style.Style({
                  image: new ol.style.Circle({
                      radius: 6,
                      fill: new ol.style.Fill({color: "yellow"}),
                      stroke: new ol.style.Stroke({color: "red", width: 2})
                  })
              })
          });
          const layers = map.getLayers();
      
      
          // Add the point layer to the map
          map.addLayer(pointLayer);
      
          // Get the current zoom level
          var currentZoom_ = map.getView().getZoom();
      
          // Set the center of the map to the selected point
          var center = [selectedItem.x, selectedItem.y];
          map.getView().animate({
              center: center,
              zoom: currentZoom_ + 2, // You can adjust the zoom level here
              duration: 1000 // Duration of the animation in milliseconds
          });
      
              } else {
                  console.warn("Selected item doesn't have x and y coordinates");
              }
          }
      });
      var shortestPathLayer;
     
      var pointLayerTarget;
      $("#targetLocation").autocomplete({
          source: availableTags,
          select: function(event, ui) {
              // Clear previous pointLayer if exists
              if (pointLayerTarget) {
                  map.removeLayer(pointLayerTarget);
              }
              const layers = map.getLayers();
      
      
      // Find the layer by name:
      const shortestPathLayer = layers.getArray().find(layer => layer.get('name') === 'shortest_path');
      if (shortestPathLayer) {
        map.removeLayer(shortestPathLayer)
      } else {
        console.error('Layer with name "shortest_path" not found on the map.');
      }
       
              // Get the selected item data
              var selectedItem = ui.item;
      
      // Check if x and y coordinates exist
      if (selectedItem.hasOwnProperty('x') && selectedItem.hasOwnProperty('y')) {
          var pointFeature = new ol.Feature();
      
          $.ajax({
                headers: { "X-CSRFToken": '{{ csrf_token }}' },
                url: '{% url "main:getNearstVertex"  %}',
                data: { selectedItem: JSON.stringify(selectedItem) },
                type: "POST",
                success: function (data) {
                    target=data.properties.id
                            pointFeature.setGeometry(new ol.geom.Point([data.geometry.coordinates[0], data.geometry.coordinates[1]]));
                            for (var key in Object.entries(data.properties)) {
                                pointFeature.set(Object.entries(data.properties)[key][0], Object.entries(data.properties)[key][1]);
                            }
                        
                },
                error: function (data) {
                    // Handle error
                }
            });
    
 
          pointLayerTarget = new ol.layer.Vector({
              source: new ol.source.Vector({
                  features: [pointFeature],
                  
              }),
              style:new ol.style.Style({
                  image: new ol.style.Circle({
                      radius: 6,
                      fill: new ol.style.Fill({color: "blue"}),
                      stroke: new ol.style.Stroke({color: "red", width: 2})
                  })
              })
          });
         
          // Add the point layer to the map
          map.addLayer(pointLayerTarget);
      
          // Get the current zoom level
          var currentZoom_ = map.getView().getZoom();
      
          // Set the center of the map to the selected point
          var center = [selectedItem.x, selectedItem.y];
          map.getView().animate({
              center: center,
              zoom: currentZoom_ + 2, // You can adjust the zoom level here
              duration: 1000 // Duration of the animation in milliseconds
          });
      
              } else {
                  console.warn("Selected item doesn't have x and y coordinates");
              }
          }
      });
      
      });
      
    
const service_styles = [
      {
      name: "Air Port",
      fill: "#3fa6f2",
      stroke: "#9d5c9e"
      },
      {
      name: "Bank",
      fill: "#7dc1eb",
      stroke: "#a187c6"
      },
      {
      name: "Beverage",
      fill: "#bc8a3b",
      stroke: "#c3cb79"
      },
      {
      name: "Bus Terminal",
      fill: "#dba71b",
      stroke: "#69d5c1"
      },
      {
      name: "Café",
      fill: "#f284ad",
      stroke: "#f5b0cc"
      },
      {
      name: "Camp Site",
      fill: "#79a855",
      stroke: "#b1b9a9"
      },
      {
      name: "Catholic Church",
      fill: "#5a57bc",
      stroke: "#e84b2e"
      },
      {
      name: "Clinic",
      fill: "#eb9b33",
      stroke: "#2fd49d"
      },
      {
      name: "College",
      fill: "#b7a54e",
      stroke: "#9a3f4d"
      },
      {
      name: "Garage",
      fill: "#cd6f8d",
      stroke: "#f78e8b"
      },
      {
      name: "Gas Station",
      fill: "#ac6ac7",
      stroke: "#d4c1ee"
      },
      {
      name: "Health Center",
      fill: "#79ad9e",
      stroke: "#b2a65c"
      },
      {
      name: "Health Post",
      fill: "#e09a6d",
      stroke: "#dc6dd1"
      },
      {
      name: "Hospital",
      fill: "#62928d",
      stroke: "#ec5f98"
      },
      {
      name: "Hotel",
      fill: "#d5a655",
      stroke: "#768c69"
      },
      {
      name: "Lodge",
      fill: "#c56d62",
      stroke: "#da9f66"
      },
      {
      name: "Mosque",
      fill: "#7d5ecf",
      stroke: "#57b6af"
      },
      {
      name: "Municipal",
      fill: "#c77864",
      stroke: "#c4e79a"
      },
      {
      name: "Museum",
      fill: "#62c680",
      stroke: "#b5527e"
      },
      {
      name: "Office",
      fill: "#6bb0f0",
      stroke: "#c6736f"
      },
      {
      name: "Open Market",
      fill: "#d5d762",
      stroke: "#cc4aa5"
      },
      {
      name: "Orthodox Church",
      fill: "#d2699d",
      stroke: "#81dd6d"
      },
      {
      name: "Pension",
      fill: "#e2e55c",
      stroke: "#5bcff1"
      },
      {
      name: "Pharmacy",
      fill: "#d766c9",
      stroke: "#76856a"
      },
      {
      name: "Police Station",
      fill: "#669ecf",
      stroke: "#b67667"
      },
      {
      name: "Protestant Church",
      fill: "#e0d25e",
      stroke: "#5c85d2"
      },
      {
      name: "Repair",
      fill: "#61d49d",
      stroke: "#e27298"
      },
      {
      name: "Restaurant",
      fill: "#cc858f",
      stroke: "#98bd5f"
      },
      {
      name: "School",
      fill: "#7bd64e",
      stroke: "#d452a8"
      },
      {
      name: "Stadium",
      fill: "#6587c7",
      stroke: "#f7905a"
      },
      {
      name: "Super Market",
      fill: "#bc69e0",
      stroke: "#5c8d60"
      },
      {
      name: "University",
      fill: "#e16a73",
      stroke: "#68a363"
      }
      ]
      
      const destination_styles = [
      {
      name: "Cultural",
      fill: "#5fccc",
      stroke: "#6ffc9e"
      },
      {
      name: "Man Made",
      fill: "#7a899",
      stroke: "blue"
      },
      {
      name: "Natural",
      fill: "#32ccc",
      stroke: "red"
      },
      ]
      
      function getDynamicStyle(coord) {
          if(coord.whattype=="services"){
              const service_style = service_styles.find(style => style.name === coord.service_ty);
          
          if(service_style){
              return new ol.style.Style({
                  image: new ol.style.Circle({
                      radius: 6,
                      fill: new ol.style.Fill({color: service_style.fill}),
                      stroke: new ol.style.Stroke({color: service_style.stroke, width: 2})
                  })
              });
          }
          // If no matching style found, return a default style
          return new ol.style.Style({
              image: new ol.style.Circle({
                  radius: 6,
                  fill: new ol.style.Fill({color: 'gray'}),
                  stroke: new ol.style.Stroke({color: 'black', width: 2})
              })
          })
          }
      
          if(coord.whattype=="destinations"){
              const destination_style = destination_styles.find(style => style.name === coord.destinatio);
          
          if(destination_style){
              return new ol.style.Style({
                  image: new ol.style.Circle({
                      radius: 6,
                      fill: new ol.style.Fill({color: destination_style.fill}),
                      stroke: new ol.style.Stroke({color: destination_style.stroke, width: 2})
                  })
              });
          }
          // If no matching style found, return a default style
          return new ol.style.Style({
              image: new ol.style.Circle({
                  radius: 6,
                  fill: new ol.style.Fill({color: 'gray'}),
                  stroke: new ol.style.Stroke({color: 'black', width: 2})
              })
          })
          }
      
      }
      // Function to add markers to the map based on coordinates
              function addMarkersToMap(coordinates) {
                  // Remove previous markers
                  map.getLayers().forEach(layer => {
                      if (layer.get('name') === 'markers') {
                          map.removeLayer(layer);
                      }
                  });
                  
      
              
      
              // Create a style function
              function styleFunction(coord) {
                 
                  if(coord.whattype=="services"){
                      return getDynamicStyle(coord)
      
                  }
                  if(coord.whattype=="destinations"){
                      return getDynamicStyle(coord)
                  }
                  // Condition to apply different styles
                 
              };
      
                  // Create a vector layer for markers
                  var markerLayer = new ol.layer.Vector({
                      name: 'markers',
                      source: new ol.source.Vector(),
                       
                  });
          
                  // Add markers to the layer
                  coordinates.forEach(coord => {
                      if(coord.whattype=="services"){
                          var marker = new ol.Feature({
                          geometry:  new ol.geom.Point([coord.x, coord.y]),
                          whattype: "services",
                          geom: coord.geom, 
                          objectid: coord.objectid, 
                          x: coord.x, 
                          y: coord.y, 
                          z: coord.z, 
                          code: coord.code, 
                          full_name: coord.full_name,
                          short_name: coord.short_name, 
                          zone: coord.zone,
                           wereda: coord.wereda, 
                           kebele: coord.kebele, 
                           phone_line: coord.phone_line,
                            email: coord.email, 
                            website: coord.website, 
                            service_ty: coord.service_ty,
                             owner_name: coord.owner_name, 
                             moto: coord.moto
                      });
                      marker.setStyle(styleFunction(coord))
                      markerLayer.getSource().addFeature(marker);
                      }
                      if(coord.whattype=="destinations"){
                          var marker = new ol.Feature({
                          geometry:  new ol.geom.Point([coord.x, coord.y]),
                          geom: coord.geom,
                          whattype: "destinations",
          objectid: coord.objectid,
          name: coord.name,
          datetimes: coord.datetimes,
          elevation: coord.elevation,
          code: coord.code,
          full_name: coord.full_name,
          short_name: coord.short_name,
          zone: coord.zone,
          wereda: coord.wereda,
          kebele: coord.kebele,
          locality_n: coord.locality_n,
          organizati: coord.organizati,
          destinatio: coord.destinatio,
          status: coord.status,
          area_sqkm: coord.area_sqkm,
          yearly_est: coord.yearly_est,
          unesco_reg: coord.unesco_reg,
          descriptio: coord.descriptio,
          photo_no: coord.photo_no,
          photo_loca: coord.photo_loca,
          site_des_a: coord.site_des_a,
          amharic: coord.amharic,
          english: coord.english,
          x: coord.x,
          y: coord.y,
          image1: coord.image1,
          image2: coord.image2
                      });
                      marker.setStyle(styleFunction(coord))
                      markerLayer.getSource().addFeature(marker);
                      }
                      
                      
                  });
          
                  // Add the marker layer to the map
                  map.addLayer(markerLayer);
                  
                  function getFeaturesExtent(vectorLayer) {
                      
                  let extent = null;
                  vectorLayer.getSource().forEachFeature(function(feature) {
                      const featureGeometry = feature.getGeometry();
                      const featureExtent = featureGeometry.getExtent();
                      
                      if (!extent) {
                      extent = featureExtent.slice(); // Create a copy to avoid modification
                      } else {
                      extent = ol.extent.extend(extent, featureExtent);
                      }
                  });
                  return extent;
                  }
      
                  const featuresExtent = getFeaturesExtent(markerLayer);
      
                  const center = ol.extent.getCenter(featuresExtent);
                  
                  map.getView().animate({
                  center:center,
                  extent: featuresExtent,
                  zoom: currentZoom + 2, 
                  duration: 500 // Set the desired animation duration
      
                  });
      
              }
          
              $(document).ready(function () {
                  
                  $('.collapse-icon').click(function (event) {
                      event.stopPropagation();
                      $(this).toggleClass('bi-chevron-right bi-chevron-down');
                      var $ul = $(this).siblings('ul');
                      if ($ul.length > 0) {
                          $ul.toggle();
                      }
                  });
          
                  function getCheckedLeafNodes($node) {
                      var checkedLeafNodes = [];
                      $node.find(':checkbox:checked').each(function () {
                          var $checkbox = $(this);
                          if ($checkbox.siblings('ul').length === 0) {
                              if($checkbox.data('whattype')=="services")
                              {
                                  checkedLeafNodes.push({
          id: $checkbox.attr('id'),
          whattype: $checkbox.data('whattype'),
          geom: $checkbox.data('geom'),
          objectid: $checkbox.data('objectid'),
          x: $checkbox.data('x'),
          y: $checkbox.data('y'),
          z: $checkbox.data('z'),
          code: $checkbox.data('code'),
          full_name: $checkbox.data('full_name'),
          short_name: $checkbox.data('short_name'),
          zone: $checkbox.data('zone'),
          wereda: $checkbox.data('wereda'),
          kebele: $checkbox.data('kebele'),
          phone_line: $checkbox.data('phone_line'),
          email: $checkbox.data('email'),
          website: $checkbox.data('website'),
          service_ty: $checkbox.data('service_ty'),
          owner_name: $checkbox.data('owner_name'),
          moto: $checkbox.data('moto')
      });
                              }
                              if($checkbox.data('whattype')=="destinations")
                              {
                                  checkedLeafNodes.push({
          id: $checkbox.attr('id'),
          whattype: $checkbox.data('whattype'),
          geom: $checkbox.data('geom'),
          objectid: $checkbox.data('objectid'),
          name: $checkbox.data('name'),
          datetimes: $checkbox.data('datetimes'),
          elevation: $checkbox.data('elevation'),
          code: $checkbox.data('code'),
          full_name: $checkbox.data('full_name'),
          short_name: $checkbox.data('short_name'),
          zone: $checkbox.data('zone'),
          wereda: $checkbox.data('wereda'),
          kebele: $checkbox.data('kebele'),
          locality_n: $checkbox.data('locality_n'),
          organizati: $checkbox.data('organizati'),
          destinatio: $checkbox.data('destinatio'),
          status: $checkbox.data('status'),
          area_sqkm: $checkbox.data('area_sqkm'),
          yearly_est: $checkbox.data('yearly_est'),
          unesco_reg: $checkbox.data('unesco_reg'),
          descriptio: $checkbox.data('descriptio'),
          photo_no: $checkbox.data('photo_no'),
          photo_loca: $checkbox.data('photo_loca'),
          site_des_a: $checkbox.data('site_des_a'),
          amharic: $checkbox.data('amharic'),
          english: $checkbox.data('english'),
          x: $checkbox.data('x'),
          y: $checkbox.data('y'),
          image1: $checkbox.data('image1'),
          image2: $checkbox.data('image2')
      });
                              }
                          }
                      });
          
                      $node.find('ul').each(function () {
                          var childLeafNodes = getCheckedLeafNodes($(this));
                          checkedLeafNodes = checkedLeafNodes.concat(childLeafNodes);
                      });
          
                      return checkedLeafNodes;
                  }
          
                  function toggleChildren($parentCheckbox) {
                      var isChecked = $parentCheckbox.prop('checked');
                      $parentCheckbox.siblings('ul').find(':checkbox').prop('checked', isChecked);
                  }
          
                  
                  $('.tree-view :checkbox').change(function () {
                      var $parentCheckbox = $(this);
                      toggleChildren($parentCheckbox);
                      // Get checked leaf nodes after toggling children
                      var checkedLeafNodes = getCheckedLeafNodes($parentCheckbox.closest('ul'));
      
                      // Add markers to the map based on checked coordinates
                      addMarkersToMap(checkedLeafNodes);
                  });
          
                  // Trigger checkbox change event on page load to display checked points
                  $('.tree-view :checkbox:checked').trigger('change');
              });
              

</script>
{% endblock content %}